<div class="restaurant-order-details" *ngIf="orderData">
  <div class="row">
    <!-- Left Section - Order Details -->
    <div class="col-lg-7 col-md-7 col-sm-12">
      <div class="order-section">
        <!-- Order Header -->
        <div class="order-header">
          <div class="order-info">
            <h4>Order Id #{{ orderData?.order_id || "Unknown" }}</h4>
            <div class="order-meta">
              <span class="order-status">
                <span class="status-badge" [ngClass]="getStatusClass()">
                  {{ orderData?.status || "Unknown" }}
                </span>
              </span>
              <span class="order-date">{{
                getFormattedDate(orderData?.date_ordered)
              }}</span>
            </div>
          </div>
          <div class="order-actions">
            <div class="first-button-block position-relative">
              <span
                class="assign-man-button"
                (click)="toggleDeliverymanDropdown()"
              >
                <app-smallest-spinner *ngIf="isLoading()" />
                Assign Deliveryman
                <span>
                  <i
                    [ngClass]="
                      !isDeliverymanDropdownOpen()
                        ? 'fa-caret-down'
                        : 'fa-caret-up'
                    "
                    class="fa-solid"
                  ></i>
                </span>
              </span>
              <div
                class="rider__container"
                [ngClass]="{ show: isDeliverymanDropdownOpen() }"
              >
                <div class="rider__container__search">
                  <input
                    type="text"
                    placeholder="Search riders..."
                    [(ngModel)]="searchTerm"
                  />
                </div>

                <!-- Show riders if there are results -->
                <ng-container *ngIf="filteredRiders.length > 0">
                  <div
                    class="rider__container__rider"
                    *ngFor="let rider of filteredRiders"
                    (click)="selectRider(rider)"
                  >
                    <div class="img-con">
                      <img
                        [src]="
                          rider.profile_image ||
                          '/assets/images/no-profile-image.jpg'
                        "
                        [alt]="rider.full_name"
                        (click)="
                          $event.stopPropagation();
                          openImage(rider.profile_image)
                        "
                      />
                    </div>
                    <div class="info-con">
                      <h1
                        class="name"
                        [innerHTML]="highlightMatch(rider.full_name)"
                      ></h1>
                      <p
                        class="number"
                        [innerHTML]="highlightMatch(rider.phone)"
                      ></p>
                    </div>
                  </div>
                </ng-container>

                <!-- Show no results message -->
                <div
                  class="no-results-con"
                  *ngIf="filteredRiders.length === 0 && searchTerm"
                >
                  <h1>
                    <span><svg-icons name="glass" /></span>No Results
                  </h1>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Section -->
        <div class="delivery-section">
          <div class="section-header">
            <h5><i class="fa-solid fa-truck"></i> Deliveryman</h5>
          </div>

          <div class="delivery-content">
            <div class="delivery-info">
              <span class="delivery-label">Order</span>
              <span class="delivery-time">
                Status: {{ orderData?.status || "Unknown" }}
              </span>
            </div>

            <!-- Order Tracking Map -->
            <div class="delivery-map-container">
              <p *ngIf="orderData?.pickup_location">
                üìç Pickup: {{ orderData.pickup_location.lat }},
                {{ orderData.pickup_location.lng }}
              </p>
              <p *ngIf="orderData?.dropoff_location">
                üè† Dropoff: {{ orderData.dropoff_location.lat }},
                {{ orderData.dropoff_location.lng }}
              </p>
              <p *ngIf="orderData?.current_location">
                üöö Current: {{ orderData.current_location.lat }},
                {{ orderData.current_location.lng }}
              </p>
              <p *ngIf="!orderData?.pickup_location">
                Map integration coming soon...
              </p>
            </div>

            <!-- Delivery Progress -->
            <div class="delivery-progress">
              <div
                class="progress-item"
                *ngFor="let person of getDeliveryProgress(); let i = index"
                [ngClass]="{
                  completed: isDeliveryPersonCompleted(person),
                  active: isDeliveryPersonActive(person)
                }"
              >
                <div class="progress-icon">
                  <i
                    class="fa-solid fa-check"
                    *ngIf="isDeliveryPersonCompleted(person)"
                  ></i>
                  <div
                    class="active-indicator"
                    *ngIf="isDeliveryPersonActive(person)"
                  ></div>
                  <i
                    class="fa-solid fa-star"
                    *ngIf="isDeliveryPersonPending(person)"
                  ></i>
                </div>
                <div class="progress-details">
                  <div
                    class="deliveryman-info"
                    *ngIf="person.name !== 'Started' && person.avatar"
                  >
                    <img
                      [src]="person.avatar || 'assets/images/profile-img.png'"
                      [alt]="person.name"
                      class="deliveryman-avatar"
                    />
                    <div class="deliveryman-details">
                      <h6>{{ person.name }}</h6>
                      <span *ngIf="person.phone">{{ person.phone }}</span>
                    </div>
                  </div>
                  <div
                    class="status-info"
                    *ngIf="person.name === 'Started' || !person.avatar"
                  >
                    <span class="status-text">{{ person.name }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div
          class="order-items-section"
          *ngIf="orderData?.items && orderData.items.length > 0"
        >
          <div class="order-item" *ngFor="let item of orderData.items">
            <div class="item-icon">
              <i class="fa-solid fa-utensils"></i>
            </div>
            <div class="item-details">
              <span class="item-name">
                {{ item?.food_name || "Food Item #" + item?.food }}
                <small *ngIf="item?.quantity > 1"> x{{ item.quantity }}</small>
              </span>
              <span class="item-price">{{
                formatCurrency(getItemTotal(item))
              }}</span>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-item">
            <span>Payment Method</span>
            <span>{{ orderData?.payment_method || "Not specified" }}</span>
          </div>
          <div class="summary-item">
            <span>Payment Status</span>
            <span>{{ orderData?.payment_status || "Unknown" }}</span>
          </div>
          <div
            class="summary-item"
            *ngIf="orderData?.items && orderData.items.length > 0"
          >
            <span>Subtotal</span>
            <span>{{ formatCurrency(getSubtotal()) }}</span>
          </div>
          <div class="summary-item">
            <span>Delivery Fee</span>
            <span>{{ formatCurrency(getDeliveryFee()) }}</span>
          </div>
          <div class="summary-item">
            <span>Platform Fee</span>
            <span>{{ formatCurrency(getPlatformFee()) }}</span>
          </div>
          <div class="summary-item">
            <span>Tax</span>
            <span>{{ formatCurrency(getTax()) }}</span>
          </div>
          <div class="summary-item total">
            <span><strong>Total</strong></span>
            <span
              ><strong>{{ formatCurrency(getGrandTotal()) }}</strong></span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Right Section - Customer Info -->
    <div class="col-lg-5 col-md-5 col-sm-12">
      <div class="customer-section" *ngIf="orderData?.customer">
        <div class="section-header">
          <h5><i class="fa-solid fa-user"></i> Customer info</h5>
        </div>

        <!-- Customer Profile -->
        <div class="customer-profile">
          <div class="customer-avatar">
            <img
              *ngIf="orderData.customer.photo_url; else customerInitials"
              [src]="orderData.customer.photo_url"
              [src]="orderData.customer.photo_url"
              [alt]="(orderData.customer.name || 'Customer') + ' profile image'"
              class="img-fluid"
              (error)="hasProfile.set(false)"
            />
            <ng-template #customerInitials>
              <div class="avatar-initials">
                {{ getCustomerInitials() }}
              </div>
            </ng-template>
          </div>
          <div class="customer-details">
            <h4>{{ orderData.customer.name || "Unknown Customer" }}</h4>
            <p>{{ orderData.customer.email || "No email provided" }}</p>
            <div class="customer-stats">
              <span class="total-orders"
                >Customer ID:
                {{ orderData.customer.customer_id || "Unknown" }}</span
              >
              <span class="student-badge" *ngIf="orderData.customer.is_student"
                >Student</span
              >
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="contact-info">
          <div class="contact-item">
            <span class="contact-label">Phone Number</span>
            <span class="contact-value">
              <a
                *ngIf="orderData.customer.phone; else noPhone"
                [href]="'tel:' + orderData.customer.phone"
                class="phone-link"
                (click)="onCallCustomer()"
              >
                {{ orderData.customer.phone }}
              </a>
              <ng-template #noPhone>
                <span>No phone number</span>
              </ng-template>
            </span>
          </div>
        </div>

        <!-- Location Info -->
        <div class="location-info">
          <div class="location-item">
            <span class="location-label">Location</span>
            <span class="location-value">{{
              orderData.customer.location || "Unknown location"
            }}</span>
          </div>
        </div>

        <!-- Delivery Address -->
        <div class="delivery-address">
          <h6>Deliver To</h6>
          <div class="address-item">
            <div class="address-icon">
              <i class="fa-solid fa-location-dot"></i>
            </div>
            <div class="address-details">
              <div class="address-type">Current Address</div>
              <div class="address-text">
                {{ orderData.customer.location || "Address not provided" }}
              </div>
            </div>
          </div>
          <div class="address-item" *ngIf="orderData?.dropoff_location">
            <div class="address-icon">
              <i class="fa-solid fa-map-pin"></i>
            </div>
            <div class="address-details">
              <div class="address-type">Coordinates</div>
              <div class="address-text">
                {{ orderData.dropoff_location.lat }},
                {{ orderData.dropoff_location.lng }}
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Guy -->
        <div class="delivery-guy" *ngIf="orderData?.rider">
          <h6>Delivery Guy</h6>
          <div class="delivery-guy-info">
            <div class="delivery-guy-avatar">
              <img
                *ngIf="orderData.rider.profile_image_url; else riderInitials"
                [src]="orderData.rider.profile_image_url"
                [alt]="
                  (orderData.rider.full_name || 'Rider') + ' profile image'
                "
                class="img-fluid"
              />
              <ng-template #riderInitials>
                <div class="avatar-initials">
                  {{ getRiderInitials() }}
                </div>
              </ng-template>
            </div>
            <div class="delivery-guy-details">
              <h6>{{ orderData.rider.full_name || "Unknown Rider" }}</h6>
              <span *ngIf="orderData.rider.phone">{{
                orderData.rider.phone
              }}</span>
              <span *ngIf="orderData.rider.rider_code"
                >Code: {{ orderData.rider.rider_code }}</span
              >
              <p
                class="rider-status"
                [ngClass]="orderData.rider.is_active ? 'active' : 'inactive'"
              >
                {{ orderData.rider.is_active ? "Active" : "Inactive" }}
              </p>
            </div>
            <div class="delivery-guy-actions">
              <button
                class="delivery-guy-btn"
                (click)="onCallRider()"
                title="Call rider"
                [disabled]="!orderData.rider.phone"
              >
                <i class="fa-solid fa-phone"></i>
              </button>
              <button
                class="delivery-guy-btn"
                (click)="onMessageRider()"
                title="Message rider"
              >
                <i class="fa-solid fa-message"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- No Delivery Guy Assigned -->
        <div class="delivery-guy" *ngIf="!orderData?.rider">
          <h6>Delivery Guy</h6>
          <div class="no-delivery-guy">
            <p>No delivery person assigned yet</p>
            <button
              class="btn btn-primary btn-sm"
              (click)="toggleDeliverymanDropdown()"
            >
              Assign Rider
            </button>
          </div>
        </div>

        <!-- Real-time Connection Status -->
        <div class="connection-status" *ngIf="orderData">
          <div class="status-indicator">
            <div class="connection-dot"></div>
            <span class="status-text">Real-time updates active</span>
          </div>
        </div>

        <!-- Order Actions -->
        <div class="order-actions-panel">
          <h6>Quick Actions</h6>
          <div class="action-buttons">
            <!-- Status Update Buttons -->
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="onStatusChange('Accepted')"
              [disabled]="isLoading() || orderData?.status === 'Accepted'"
            >
              Accept Order
            </button>
            <button
              class="btn btn-sm btn-outline-warning"
              (click)="onStatusChange('Being prepared')"
              [disabled]="isLoading() || orderData?.status === 'Being prepared'"
            >
              Start Preparing
            </button>
            <button
              class="btn btn-sm btn-outline-info"
              (click)="onStatusChange('On the way')"
              [disabled]="isLoading() || orderData?.status === 'On the way'"
            >
              Out for Delivery
            </button>
            <button
              class="btn btn-sm btn-outline-success"
              (click)="onStatusChange('Delivered')"
              [disabled]="isLoading() || orderData?.status === 'Delivered'"
            >
              Mark as Delivered
            </button>
          </div>

          <!-- Payment Status Actions -->
          <div
            class="payment-actions"
            *ngIf="orderData?.payment_status !== 'Paid'"
          >
            <h6>Payment Actions</h6>
            <button
              class="btn btn-sm btn-success"
              (click)="onPaymentStatusChange('Paid')"
              [disabled]="isLoading()"
            >
              Mark as Paid
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div class="loading-container" *ngIf="!orderData && isLoading()">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading order details...</p>
  </div>
</div>

<!-- Error state -->
<div class="error-container" *ngIf="!orderData && !isLoading()">
  <div class="error-message">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <h3>Order Not Found</h3>
    <p>
      The requested order could not be loaded. Please check the order ID and try
      again.
    </p>
    <button class="btn btn-primary" (click)="loadOrderDetails()">Retry</button>
  </div>
</div>
